[toc]

# 行为

行为是object对象的一种字典属性，不会显示，其保存了与对象有关的各种效果函数组成的行为对象

## 结构

~~~
object对象:{
    行为：{
        行为对象键（在行为内唯一）：{
            *“之前”：可选，值参见↓
            “当时”:[
                行为效果对象（复数个）{
                    词条:词条对象数组
                    优先级:数字或优先级字符串
                    来源:这个效果的触发来源
                    效果:这个效果触发时运行的函数
                }
            ]
            *“之后”：可选，值参见↑
        },
        行为对象字典键（在行为内唯一）：{
        	行为对象键（在字典内唯一）：{值同上},
        	行为对象字典键（在字典内唯一）：{略}
        }
    }
}
~~~



### 行为对象

#### 行为对象的键 => 执行时刻

行为对象以键值对的形式存储在object对象的[行为]中，其键key表明这个行为的执行时刻，固定且默认的用法包括：

```
加入：当该对象加入【虫巢】时，触发的行为，也包括对象诞生在虫巢中的情况
离开：当该对象从【虫巢】中离开时，触发的行为

获得：当该对象被一个【object对象】获得时，触发的行为，包括【特性】【设施】【工作】【天赋】等对象被获得
失去：当该对象从一个【object对象】中失去时，触发的行为

诞生：当该【生物对象】被创建（create）时，触发的行为
死亡：当该【生物对象】的“寿命”达到max，或“生命”<=0时，触发的行为
摧毁：当该【非生物对象】的“耐久”<=0时，触发的行为，也包括设施被”拆除“的情况

回合开始：当【回合开始】时，对象的功能能够正常起效时，触发的行为
回合结算：当【回合结束】时，对象的功能能够正常起效时，触发的行为

效果：当对象被指名触发时，触发的效果，通常是【特性】对象等

"开始" : 当一个【事件】或【工作】开始时，执行的行为
"需求" : 判定一个【事件】或【工作】是否可以开始的行为，返回true或false
"效率" : 计算一个参与【工作】的对象能为这个【工作】提供的效率的行为，返回一个数字
“中断” : 当一个【事件】或【工作】中途结束时，执行的行为
"完成" : 当一个【事件】或【工作】完成时，执行的行为
```

这些键都直接存储在对象的[行为]中，如果需要设置的行为对象键与上述内容冲突，需要放置在行为对象字典中

#### 值/执行内容

行为对象的值也是键值对，其中key又称“时间标识”，包括且**固定**为：

```
之前：表示这个行为触发“当时”效果之前，触发的效果
当时：表示这个行为进行时触发的效果
之后：表示这个行为的“当时”效果触发完之后，触发的效果
```

这些键对应的值是一个【行为效果】组成的**数组**，在行为触发时，便会按照之前→当时→之后的顺序触发对应的数组内的行为效果，在数组内，又会按照效果优先级>数组顺序的方式来触发对应的【行为效果】

### 行为效果

【行为效果】与【效果】类似，但其表示的是“行动将要产生怎样的效果”，而不是“对象受到的效果”，【行为效果】并不具备“行为”属性，而是直接以“效果”存储着函数，【行为效果】只能存在在【行为Movement对象】内。

行为效果本身是一个字典

#### 行为效果的值

~~~
{
	词条:词条数组,默认为空数组
	优先级:数字,默认为0
	效果:函数function,不可为空
}
~~~

------------

## 方法

### 1.将JSON内容/js对象转化为一个【行为效果】：jsToMovementEffect(source, move_data)

​	source：这个【行为效果】的来源
​	move_data：一个字典数据结构，其内容类似：

~~~
{ 
    词条: 词条数组, 默认为空数组
    优先级: 数字或优先级字符串,  默认为0
    效果: 一个函数，不可为空
}
~~~

​			move_data也可以是一个函数

​	如果move_data是一个单纯的函数，则【行为效果】的[词条]，[优先级]均为默认值，[效果]为move_data对应的函数。
​	返回【行为效果】[来源=source]，这是一个存储着效果函数的字典，而非效果effect对象

### 2.将func_lib的内容初始化为object的[行为]属性：initMovement(object, func_lib, move_belong = [])

​	object：获得[行为]属性的对象
​	func_lib：一个行为对象字典，具体内容格式请参见：文件对象→func_lib
​	*move_belong：可选，字符串数组，默认为空数组，参加下方move_belong的说明

​	遍历func_lib中的行为对象数据，并依次调用addMovement为object添加行为对象，需要注意的是，这些行为对象的来源move_source都是这个object自身，因此本函数只建议在初始化对象时使用

### 3.为一个对象的[行为]属性添加一个行为对象or行为对象字典：addMovement(*object*, *move_key*, *move_data*, *move_source*, *move_belong*=[])

​	object：添加行为对象or行为对象字典的对象
​	move_key：添加的行为的or行为对象字典的键名
​	move_data：添加的行为对象的数据，其中的内容可以是：

~~~
1.带有时间标识的行为对象数据：
eg:{
	*之前:{...}
	当时:{
		*词条:["123","456"]
		*优先级:999
		效果:function()
	},
	*之后:{...}
}

2.单个的函数：
eg:function()

3.行为对象字典：
eg:{
	启动:{...}
	关闭:{...}
}
~~~

​	move_source：行为对象的行为效果的来源
​	*move_belong：可选，字符串数组，默认为空数组，通常用于产生行为对象字典，本函数中的产生的行为对象会被放置在object[行为→[move_belong]]中，**注意**：请不要将move_key放置在move_belong当中！

​	所有行为对象都会放置在object[行为]中，如果move_belong不为空，则还会根据其中的内容依次放置到object[行为→[move_belong]]所在的位置，从而生成行为对象字典
​	如果没有找到[move_belong]指名的位置，则会报错
​	1.若move_data中包含时间标识：“之前”“当时”“之后”，分别读取对应时间标识内存储的行为对象数据，转化为行为对象，并放置在对应的时间标识中
​	2.若move_data仅为一个函数，则将其转化为行为对象，放置在object[行为→行为键→当时]
​	3.若move_data为一个字典，则将其转化为行为对象字典，递归调用本函数，将对应key存储进move_belong当中
​	4.如果以上条件都不满足，则会报错

### 4.向一个对象的指名行为中添加一个行为效果：addMovementEffect(*object*, *move_key*, *move_effect*, *move_source*, *move_time* = "当时", *type*)

​	object：object对象，添加行为效果的对象
​	source：这个行为效果的来源
​	move_key：string或string数组，指定的行为名称或行为名称数组
​	move_effect：行为效果数据或函数，用于生成新行为效果的数据，【行为效果】的数据结构为：

~~~
{
	优先级：数字或优先级字符串
	词条：词条数组
	效果：函数function
}
~~~

​	*move_time：可选，“之前“”之后“或”当时“，默认为“当时”，新的行为效果所处的时间标识
​	*type：可选，字符串，默认为空，若为”new”，则会在没有找到move_key指名的行为对象时，创建对应的行为对象

​	通过move_key，在object[行为]中找到对应的行为对象，如果没有找到，则报错
​		如果没有找到，但是type=“new”，则会使用：move_key,move_effect,move_source,move_time来创建对应的行为对象
​	找到后，将move_effect转化为行为效果，添加到行为对象的指名move_time当中，如果此时的move_time内没有内容，则会创建行为数组后添加。

### 5.从对象已存在的行为中删除一个指定来源的效果： deleteMovementEffect(*object*, *source*, *move_key*，move_time)

​	object：删除行为对象效果的对象
​	source：指定的来源
​	move_key：字符串或字符串数组，指名的行为对象键
​	*move_time：可选，“之前，当时，之后”或三者任意组成的不重复数组，默认为空，指名的行为对象内部的指定时间标识，用于更细化地删除行为对象的效果

​	通过move_key在object中找到对应的行为对象，若未找到则报错
​	若指名了move_time，则遍历行为对象的指名的move_time的行为效果数组
​		若move_time为数组，则依次遍历其中元素指名的move_time的行为效果数组
​	若没有指定move_time，则会遍历行为对象的所有时间标识的行为效果数组
​	随后，将行为效果数组中，“来源”属性=source的行为效果删除
​	简单点说就是：如果指定了move_time，则只会删除指定move_time中的来源=source的行为效果。如果没有指定move_time，则会删除行为对象中，所有来源=source的行为效果

### 6.触发一个对象指名的行为：runObjectMovement(*object*, *move_key*, *paras*)

​	object：指定触发行为的对象
​	move_key：string或string数组，指定触发行为的key名称
​	paras：用于行为函数的参数，可以是一个数组，也可以是单个变量，还可以为空
​	
​	使用move_key查找到object中的指名行为对象
​	找到后，依次遍历其中的“之前”→“当时”→“之后”的行为效果数组
​		遍历过程中，按照优先级→数组顺序的顺序依次执行这些行为效果的“效果”函数，这些函数所使用到的参数分别是：（object，paras），如果paras是一个数组，还会将其使用“…”来解析拆分，并依次作为参数传入到”效果“函数中。

~~~
eg:runObjectMovement(object,"行为甲",[参数1，参数2，参数3])
则“行为甲”当中的行为效果函数所使用的参数分别是：（object，参数1，参数2，参数3）
~~~

​		并且，这些“效果”函数的返回值，都会被依次存储到一个数组中，如果这个数组不为空，则会使用countValue()来依次计算其中的值的和，并将最后的值返回到调用本函数的地方。
​	如果没有找到指名的行为对象，则会返回**TRUE**

### 7.获取一个object的指名行为对象：getMovementInObject(object,move_key)

​	object：一个有着“行为”属性的对象
​	move_key：字符串或字符串数组，获取的行为对象在object中具备的key，如果要查找一个行为对象字典中的行为对象，则需要将这个行为对象字典的key放在这个行为对象的key之前形成一个数组

​	如果move_key是一个数组，则会遍历这个数组，并尝试在object的[行为]属性中依次寻找其中的key，一旦没有找到某个key，则会报错返回false
​	如果最终找到了一个行为对象，则会返回这个行为对象
​	如果是一个字符串，则只会在object[行为]中寻找对应move_key的行为对象或行为对象数组，并将其返回

